<!-- Page Header -->
<div class="page-header">
  <div class="header-content">
    <h1>My Reviews</h1>
    <p>Share your experience and help others choose the perfect room</p>
  </div>
</div>

<div class="reviews-container">
  <nz-spin [nzSpinning]="loading">
    <!-- Info Alert -->
    <nz-alert
      *ngIf="!loading"
      nzType="info"
      [nzMessage]="alertMessage"
      [nzShowIcon]="true"
      class="info-alert">
      <ng-template #alertMessage>
        <span nz-icon nzType="info-circle"></span>
        You can write reviews for rooms after your stay is complete (checked out).
        Reviews help other guests make informed decisions.
      </ng-template>
    </nz-alert>

    <!-- Empty State -->
    <div *ngIf="!loading && myReviews.length === 0" class="empty-state">
      <nz-empty [nzNotFoundImage]="emptyImage" [nzNotFoundContent]="emptyContent" [nzNotFoundFooter]="emptyFooter">
        <ng-template #emptyImage>
          <span nz-icon nzType="star" class="empty-icon"></span>
        </ng-template>
        <ng-template #emptyContent>
          <div class="empty-text">
            <h3>No reviews yet</h3>
            <p>After completing a stay, you'll be able to share your experience here</p>
          </div>
        </ng-template>
        <ng-template #emptyFooter>
          <button nz-button nzType="primary" routerLink="/customer/bookings">
            <span nz-icon nzType="calendar"></span> View My Bookings
          </button>
        </ng-template>
      </nz-empty>
    </div>

    <!-- Reviews List -->
    <div class="reviews-list" *ngIf="myReviews.length > 0">
      <nz-card *ngFor="let review of myReviews" class="review-card" [nzBorderless]="true">
        <!-- Card Header -->
        <div class="review-header">
          <div class="room-info">
            <h3>{{ review.roomName }}</h3>
            <nz-tag nzColor="purple" [nzBordered]="false">{{ review.roomType }}</nz-tag>
          </div>
          <div class="meta-info">
            <nz-tag [nzColor]="getStatusColor(review)">
              <span nz-icon [nzType]="review.isApproved ? 'check-circle' : 'clock-circle'"></span>
              {{ getStatusText(review) }}
            </nz-tag>
            <span class="date">{{ review.createdAt | date:'dd MMM yyyy' }}</span>
          </div>
        </div>

        <!-- Rating Section -->
        <div class="rating-section">
          <div class="overall-rating">
            <nz-rate [ngModel]="review.overallRating" nzDisabled nzAllowHalf></nz-rate>
            <span class="rating-value">{{ review.overallRating }}/5</span>
          </div>

          <!-- Detailed Ratings -->
          <div class="detailed-ratings" *ngIf="hasDetailedRatings(review)">
            <div class="rating-item" *ngIf="review.cleanlinessRating">
              <span class="label">Cleanliness</span>
              <nz-progress [nzPercent]="review.cleanlinessRating * 20" [nzShowInfo]="false" nzSize="small" nzStrokeColor="#6a1b9a"></nz-progress>
              <span class="value">{{ review.cleanlinessRating }}</span>
            </div>
            <div class="rating-item" *ngIf="review.serviceRating">
              <span class="label">Service</span>
              <nz-progress [nzPercent]="review.serviceRating * 20" [nzShowInfo]="false" nzSize="small" nzStrokeColor="#6a1b9a"></nz-progress>
              <span class="value">{{ review.serviceRating }}</span>
            </div>
            <div class="rating-item" *ngIf="review.amenitiesRating">
              <span class="label">Amenities</span>
              <nz-progress [nzPercent]="review.amenitiesRating * 20" [nzShowInfo]="false" nzSize="small" nzStrokeColor="#6a1b9a"></nz-progress>
              <span class="value">{{ review.amenitiesRating }}</span>
            </div>
            <div class="rating-item" *ngIf="review.valueForMoneyRating">
              <span class="label">Value</span>
              <nz-progress [nzPercent]="review.valueForMoneyRating * 20" [nzShowInfo]="false" nzSize="small" nzStrokeColor="#6a1b9a"></nz-progress>
              <span class="value">{{ review.valueForMoneyRating }}</span>
            </div>
          </div>
        </div>

        <!-- Review Content -->
        <div class="review-content">
          <h4 *ngIf="review.title" class="review-title">{{ review.title }}</h4>
          <p class="review-comment">{{ review.comment }}</p>

          <!-- Pros and Cons -->
          <div class="pros-cons" *ngIf="review.pros || review.cons">
            <div class="pros" *ngIf="review.pros">
              <span nz-icon nzType="like" nzTheme="fill"></span>
              <span>{{ review.pros }}</span>
            </div>
            <div class="cons" *ngIf="review.cons">
              <span nz-icon nzType="dislike" nzTheme="fill"></span>
              <span>{{ review.cons }}</span>
            </div>
          </div>
        </div>

        <!-- Admin Response -->
        <div class="admin-response" *ngIf="review.adminResponse">
          <div class="response-header">
            <span nz-icon nzType="message" nzTheme="fill"></span>
            <strong>Hotel Response</strong>
            <span class="response-date" *ngIf="review.adminResponseAt">{{ review.adminResponseAt | date:'dd MMM yyyy' }}</span>
          </div>
          <p>{{ review.adminResponse }}</p>
        </div>

        <!-- Actions -->
        <div class="review-actions" *ngIf="!review.isApproved">
          <button nz-button nzType="default" (click)="showEditModal(review)">
            <span nz-icon nzType="edit"></span> Edit
          </button>
          <button nz-button nzType="default" nzDanger
                  nz-popconfirm
                  nzPopconfirmTitle="Are you sure you want to delete this review?"
                  (nzOnConfirm)="deleteReview(review.id)">
            <span nz-icon nzType="delete"></span> Delete
          </button>
        </div>

        <!-- Approved Notice -->
        <div class="approved-notice" *ngIf="review.isApproved">
          <span nz-icon nzType="check-circle" nzTheme="fill"></span>
          This review has been published and cannot be edited
        </div>
      </nz-card>
    </div>
  </nz-spin>
</div>

<!-- Edit Review Modal -->
<nz-modal [(nzVisible)]="isModalVisible"
          nzTitle="Edit Review"
          (nzOnCancel)="handleCancel()"
          (nzOnOk)="handleSubmit()"
          [nzOkDisabled]="reviewForm.invalid"
          nzOkText="Save Changes"
          [nzWidth]="650">
  <ng-container *nzModalContent>
    <form nz-form [formGroup]="reviewForm" nzLayout="vertical">
      <!-- Overall Rating -->
      <nz-form-item>
        <nz-form-label nzRequired>Overall Rating</nz-form-label>
        <nz-form-control>
          <div class="rating-input">
            <nz-rate formControlName="overallRating" nzAllowHalf></nz-rate>
            <span class="rating-display">{{ reviewForm.get('overallRating')?.value || 0 }}/5</span>
          </div>
        </nz-form-control>
      </nz-form-item>

      <!-- Detailed Ratings -->
      <div class="detailed-rating-inputs">
        <nz-form-item>
          <nz-form-label>Cleanliness</nz-form-label>
          <nz-form-control>
            <nz-rate formControlName="cleanlinessRating" nzAllowHalf></nz-rate>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label>Service</nz-form-label>
          <nz-form-control>
            <nz-rate formControlName="serviceRating" nzAllowHalf></nz-rate>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label>Amenities</nz-form-label>
          <nz-form-control>
            <nz-rate formControlName="amenitiesRating" nzAllowHalf></nz-rate>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label>Value for Money</nz-form-label>
          <nz-form-control>
            <nz-rate formControlName="valueForMoneyRating" nzAllowHalf></nz-rate>
          </nz-form-control>
        </nz-form-item>
      </div>

      <nz-divider></nz-divider>

      <!-- Title -->
      <nz-form-item>
        <nz-form-label>Review Title</nz-form-label>
        <nz-form-control>
          <input nz-input formControlName="title" placeholder="Summarize your experience" />
        </nz-form-control>
      </nz-form-item>

      <!-- Comment -->
      <nz-form-item>
        <nz-form-label nzRequired>Your Review</nz-form-label>
        <nz-form-control nzErrorTip="Please write at least 10 characters">
          <textarea nz-input formControlName="comment"
                    placeholder="Share your detailed experience..."
                    [nzAutosize]="{ minRows: 4, maxRows: 8 }"></textarea>
        </nz-form-control>
      </nz-form-item>

      <!-- Pros and Cons -->
      <div nz-row [nzGutter]="16">
        <div nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label>
              <span nz-icon nzType="like" nzTheme="outline" style="color: #52c41a;"></span> Pros
            </nz-form-label>
            <nz-form-control>
              <input nz-input formControlName="pros" placeholder="What did you like?" />
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label>
              <span nz-icon nzType="dislike" nzTheme="outline" style="color: #ff4d4f;"></span> Cons
            </nz-form-label>
            <nz-form-control>
              <input nz-input formControlName="cons" placeholder="What could be improved?" />
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <!-- Anonymous -->
      <nz-form-item>
        <nz-form-control>
          <label nz-checkbox formControlName="isAnonymous">
            <span nz-icon nzType="user" style="margin-right: 4px;"></span>
            Post as anonymous
          </label>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>
