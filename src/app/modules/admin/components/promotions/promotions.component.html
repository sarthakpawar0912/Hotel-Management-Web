<div class="promotions-container">
  <div class="header">
    <h2>Promotions Management</h2>
    <button nz-button nzType="primary" (click)="showAddModal()">
      <span nz-icon nzType="plus"></span> Create Promotion
    </button>
  </div>

  <nz-table #promotionTable [nzData]="promotions" [nzLoading]="loading" [nzPageSize]="10">
    <thead>
      <tr>
        <th>Name</th>
        <th>Code</th>
        <th>Discount</th>
        <th>Validity</th>
        <th>Usage</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let promo of promotionTable.data">
        <td>
          <strong>{{ promo.name }}</strong>
          <div class="description">{{ promo.description }}</div>
        </td>
        <td>
          <nz-tag nzColor="blue">{{ promo.code }}</nz-tag>
        </td>
        <td>
          <span *ngIf="promo.discountType === 'PERCENTAGE'">{{ promo.discountValue }}%</span>
          <span *ngIf="promo.discountType === 'FIXED_AMOUNT'">{{ promo.discountValue | currency:'INR' }}</span>
          <div class="min-amount" *ngIf="promo.minBookingAmount">Min: {{ promo.minBookingAmount | currency:'INR' }}</div>
        </td>
        <td>
          <div>{{ promo.startDate | date:'dd MMM yyyy' }}</div>
          <div>to {{ promo.endDate | date:'dd MMM yyyy' }}</div>
          <nz-tag *ngIf="isExpired(promo.endDate)" nzColor="red">Expired</nz-tag>
        </td>
        <td>
          <span *ngIf="promo.usageLimit">{{ promo.usageCount || 0 }} / {{ promo.usageLimit }}</span>
          <span *ngIf="!promo.usageLimit">{{ promo.usageCount || 0 }} (Unlimited)</span>
        </td>
        <td>
          <nz-tag [nzColor]="promo.isActive ? 'green' : 'default'">
            {{ promo.isActive ? 'Active' : 'Inactive' }}
          </nz-tag>
        </td>
        <td>
          <button nz-button nzType="link" (click)="showEditModal(promo)">
            <span nz-icon nzType="edit"></span>
          </button>
          <button nz-button nzType="link" *ngIf="!promo.isActive" (click)="activatePromotion(promo.id)">
            <span nz-icon nzType="play-circle"></span>
          </button>
          <button nz-button nzType="link" *ngIf="promo.isActive" (click)="deactivatePromotion(promo.id)">
            <span nz-icon nzType="pause-circle"></span>
          </button>
          <button nz-button nzType="link" nzDanger (click)="deletePromotion(promo.id)">
            <span nz-icon nzType="delete"></span>
          </button>
        </td>
      </tr>
    </tbody>
  </nz-table>
</div>

<nz-modal [(nzVisible)]="isModalVisible" [nzTitle]="isEditMode ? 'Edit Promotion' : 'Create Promotion'"
          (nzOnCancel)="handleCancel()" (nzOnOk)="handleSubmit()" [nzWidth]="600">
  <ng-container *nzModalContent>
    <form nz-form [formGroup]="promotionForm" nzLayout="vertical">
      <nz-form-item>
        <nz-form-label nzRequired>Name</nz-form-label>
        <nz-form-control nzErrorTip="Name is required">
          <input nz-input formControlName="name" placeholder="Promotion Name" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>Description</nz-form-label>
        <nz-form-control>
          <textarea nz-input formControlName="description" placeholder="Description"
                    [nzAutosize]="{ minRows: 2, maxRows: 4 }"></textarea>
        </nz-form-control>
      </nz-form-item>

      <div nz-row [nzGutter]="16">
        <div nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label nzRequired>Promo Code</nz-form-label>
            <nz-form-control nzErrorTip="Code is required">
              <input nz-input formControlName="code" placeholder="PROMO2024" style="text-transform: uppercase;" />
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label nzRequired>Discount Type</nz-form-label>
            <nz-form-control>
              <nz-select formControlName="discountType">
                <nz-option nzValue="PERCENTAGE" nzLabel="Percentage (%)"></nz-option>
                <nz-option nzValue="FIXED_AMOUNT" nzLabel="Fixed Amount"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <div nz-row [nzGutter]="16">
        <div nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label nzRequired>Discount Value</nz-form-label>
            <nz-form-control nzErrorTip="Discount value is required">
              <nz-input-number formControlName="discountValue" [nzMin]="0" style="width: 100%;"></nz-input-number>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label>Max Discount Amount</nz-form-label>
            <nz-form-control>
              <nz-input-number formControlName="maxDiscountAmount" [nzMin]="0" style="width: 100%;"></nz-input-number>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <div nz-row [nzGutter]="16">
        <div nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label nzRequired>Start Date</nz-form-label>
            <nz-form-control>
              <nz-date-picker formControlName="startDate" style="width: 100%;"></nz-date-picker>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label nzRequired>End Date</nz-form-label>
            <nz-form-control>
              <nz-date-picker formControlName="endDate" style="width: 100%;"></nz-date-picker>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <div nz-row [nzGutter]="16">
        <div nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label>Min Booking Amount</nz-form-label>
            <nz-form-control>
              <nz-input-number formControlName="minBookingAmount" [nzMin]="0" style="width: 100%;"></nz-input-number>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label>Usage Limit</nz-form-label>
            <nz-form-control>
              <nz-input-number formControlName="usageLimit" [nzMin]="1" style="width: 100%;"
                               nzPlaceHolder="Leave empty for unlimited"></nz-input-number>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <nz-form-item>
        <nz-form-label>Terms & Conditions</nz-form-label>
        <nz-form-control>
          <textarea nz-input formControlName="termsAndConditions" placeholder="Terms and conditions"
                    [nzAutosize]="{ minRows: 2, maxRows: 4 }"></textarea>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>
